<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { margin-bottom: 20px; }
    #uploadSection, #markerSection, #locationSection, #gridEditor { margin-bottom: 30px; }

    #mapWrapper {
      width: 800px;
      height: 600px;
      overflow: hidden;
      border: 1px solid #ccc;
      position: relative;
      cursor: grab;
    }

    #mapContainer {
      position: absolute;
      top: 0; left: 0;
      transform-origin: top left;
    }

    #adminMapImage {
      display: block;
      width: 800px;
      height: auto;
    }

    .marker {
      width: 14px; height: 14px; background: red; border: 2px solid white;
      border-radius: 50%; position: absolute; transform: translate(-50%, -50%);
      cursor: pointer;
    }

    canvas.grid {
      position: absolute;
      top: 0; left: 0;
      pointer-events: none;
    }

    table { border-collapse: collapse; margin-top: 10px; }
    table, th, td { border: 1px solid #ccc; padding: 5px; }
    input, select, button { margin: 5px; padding: 5px; }
    #zoomControls { margin-top: 10px; }
  </style>
</head>
<body>
<h1>Admin Dashboard</h1>

<!-- Upload -->
<div id="uploadSection">
  <h3>Upload PNG Floor Map</h3>
  <input type="text" id="floorInput" placeholder="e.g. 1 or Ground" />
  <input type="file" id="mapFile" accept=".png" />
  <button id="uploadBtn">Upload</button>
  <button id="loadMapBtn">Load Map</button>
  <p id="uploadStatus"></p>
</div>

<!-- Map Section -->
<div id="markerSection">
  <h3>Map View & Pins</h3>
  <div id="zoomControls">
    <button onclick="setZoom(1)">Reset Zoom</button>
    <button onclick="setZoom(currentZoom + 0.2)">+ Zoom In</button>
    <button onclick="setZoom(currentZoom - 0.2)">â€“ Zoom Out</button>
    <button onclick="toggleFullscreen()">Fullscreen</button>
  </div>
  <div id="mapWrapper">
    <div id="mapContainer">
      <img id="adminMapImage" src="" />
      <canvas id="gridCanvas" class="grid"></canvas>
    </div>
  </div>
</div>

<!-- Location Manager -->
<div id="locationSection">
  <h3>Location Manager</h3>
  <form id="locationForm">
    <input type="hidden" id="locationId" />
    <input type="text" id="locName" placeholder="Location Name" required />
    <input type="text" id="locFloor" placeholder="Floor" />
    <input type="text" id="locZone" placeholder="Zone (optional)" />
    <input type="text" id="locQR" placeholder="QR alias" />
    <button type="submit">Save Location</button>
  </form>
  <table id="locationsTable">
    <thead><tr><th>Name</th><th>Floor</th><th>Zone</th><th>QR Alias</th><th>Actions</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<script>
let selectedFloor = '';
let markers = [];
let locations = [];
let pendingLocationForPin = null;
let currentZoom = 1;
let isDragging = false;
let dragStart = {x: 0, y: 0};
let panOffset = {x: 0, y: 0};
let walkableGrid = {};
const GRID_SIZE = 40; // pixels

function setZoom(scale) {
  currentZoom = Math.max(0.5, Math.min(3, scale));
  renderMap();
}

function toggleFullscreen() {
  const wrapper = document.getElementById('mapWrapper');
  if (!document.fullscreenElement) wrapper.requestFullscreen();
  else document.exitFullscreen();
}

function renderMap() {
  const container = document.getElementById('mapContainer');
  container.style.transform = `translate(${panOffset.x}px, ${panOffset.y}px) scale(${currentZoom})`;
}

document.getElementById('mapWrapper').addEventListener('mousedown', e => {
  isDragging = true;
  dragStart = { x: e.clientX - panOffset.x, y: e.clientY - panOffset.y };
  e.preventDefault();
});

document.addEventListener('mouseup', () => isDragging = false);
document.addEventListener('mousemove', e => {
  if (!isDragging) return;
  panOffset = { x: e.clientX - dragStart.x, y: e.clientY - dragStart.y };
  renderMap();
});

function fetchMarkers() {
  fetch('/api/markers').then(res => res.json()).then(data => {
    markers = data;
    document.querySelectorAll('.marker').forEach(el => el.remove());
    markers.filter(m => m.floor === selectedFloor).forEach(addMarkerToMap);
  });
}

function fetchLocations() {
  fetch('/api/locations').then(res => res.json()).then(data => {
    locations = data;
    const tbody = document.querySelector('#locationsTable tbody');
    tbody.innerHTML = '';
    data.forEach(loc => {
      const row = tbody.insertRow();
      row.insertCell().innerText = loc.name;
      row.insertCell().innerText = loc.floor;
      row.insertCell().innerText = loc.zone;
      row.insertCell().innerText = loc.qr_alias;
      const actions = row.insertCell();
      const editBtn = document.createElement('button');
      editBtn.textContent = 'Edit';
      editBtn.onclick = () => {
        document.getElementById('locationId').value = loc.id;
        document.getElementById('locName').value = loc.name;
        document.getElementById('locFloor').value = loc.floor;
        document.getElementById('locZone').value = loc.zone;
        document.getElementById('locQR').value = loc.qr_alias;
      };
      const delBtn = document.createElement('button');
      delBtn.textContent = 'Delete';
      delBtn.onclick = () => fetch('/api/locations/' + loc.id, { method: 'DELETE' }).then(fetchLocations);
      const pinBtn = document.createElement('button');
      pinBtn.textContent = 'Place Pin';
      pinBtn.onclick = () => {
        pendingLocationForPin = loc;
        alert('Click the map to place a pin for: ' + loc.name);
      };
      actions.appendChild(editBtn);
      actions.appendChild(delBtn);
      actions.appendChild(pinBtn);
    });
  });
}

document.getElementById('locationForm').addEventListener('submit', function (e) {
  e.preventDefault();
  const id = document.getElementById('locationId').value;
  const payload = {
    name: document.getElementById('locName').value,
    floor: document.getElementById('locFloor').value,
    zone: document.getElementById('locZone').value,
    qr_alias: document.getElementById('locQR').value
  };
  const method = id ? 'PUT' : 'POST';
  const url = id ? '/api/locations/' + id : '/api/locations';
  fetch(url, {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  }).then(() => {
    this.reset();
    fetchLocations();
  });
});

document.getElementById('uploadBtn').onclick = () => {
  const file = document.getElementById('mapFile').files[0];
  const floor = document.getElementById('floorInput').value.trim();
  if (!file || !floor) return alert('Select a file and enter floor name');
  const formData = new FormData();
  formData.append('map', file);
  formData.append('floor', floor);
  fetch('/api/upload', { method: 'POST', body: formData })
    .then(res => res.json())
    .then(result => {
      document.getElementById('uploadStatus').innerText = 'Uploaded: ' + result.file;
      loadMap();
    });
};

document.getElementById('loadMapBtn').onclick = () => {
  selectedFloor = document.getElementById('floorInput').value.trim();
  loadMap();
};

function loadMap() {
  const img = document.getElementById('adminMapImage');
  img.src = '/maps/' + selectedFloor + '.png';
  img.onload = () => {
    document.getElementById('gridCanvas').width = img.width;
    document.getElementById('gridCanvas').height = img.height;
    fetchMarkers();
    renderMap();
  };
}

document.getElementById('mapContainer').onclick = function (e) {
  if (!pendingLocationForPin || !selectedFloor) return;
  const rect = this.getBoundingClientRect();
  const x = (e.clientX - rect.left - panOffset.x) / currentZoom;
  const y = (e.clientY - rect.top - panOffset.y) / currentZoom;
  fetch('/api/markers', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      location_id: pendingLocationForPin.id,
      x: Math.round(x),
      y: Math.round(y),
      floor: selectedFloor
    })
  }).then(() => {
    pendingLocationForPin = null;
    fetchMarkers();
  });
};

function addMarkerToMap(m) {
  const container = document.getElementById('mapContainer');
  const marker = document.createElement('div');
  marker.className = 'marker';
  marker.style.left = m.x + 'px';
  marker.style.top = m.y + 'px';
  marker.setAttribute('title', m.name || 'Unknown');
  marker.onclick = () => alert('Marker linked to: ' + (m.name || 'Unknown'));
  container.appendChild(marker);
}

fetchLocations();
</script>
</body>
</html>
