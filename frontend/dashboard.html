<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { margin-bottom: 20px; }
    #uploadSection, #markerSection, #locationSection { margin-bottom: 30px; }
    #mapWrapper {
      width: 100vw;
      height: 80vh;
      overflow: hidden;
      border: 1px solid #ccc;
      position: relative;
      cursor: grab;
    }
    #mapContainer {
      position: absolute;
      top: 0; left: 0;
      transform-origin: top left;
    }
    #adminMapImage {
      display: block;
      width: 100%;
      height: auto;
    }
    .marker {
      width: 14px; height: 14px; background: red; border: 2px solid white;
      border-radius: 50%; position: absolute; transform: translate(-50%, -50%);
      cursor: move;
    }
    .draggable-marker {
      width: 20px; height: 20px; background: green;
      display: inline-block; margin-left: 5px;
      cursor: grab; border-radius: 50%;
    }
    table { border-collapse: collapse; margin-top: 10px; }
    table, th, td { border: 1px solid #ccc; padding: 5px; }
    input, select, button { margin: 5px; padding: 5px; }
    #zoomControls { margin-top: 10px; }
  </style>
</head>
<body>
<h1>Admin Dashboard</h1>

<div id="uploadSection">
  <h3>Upload PNG Floor Map</h3>
  <input type="text" id="floorInput" placeholder="e.g. 1 or Ground" />
  <input type="file" id="mapFile" accept=".png" />
  <button id="uploadBtn">Upload</button>
  <button id="loadMapBtn">Load Map</button>
  <p id="uploadStatus"></p>
</div>

<div id="markerSection">
  <h3>Map View & Pins</h3>
  <div id="zoomControls">
    <button onclick="setZoom(1)">Reset Zoom</button>
    <button onclick="setZoom(currentZoom + 0.2)">+ Zoom In</button>
    <button onclick="setZoom(currentZoom - 0.2)">â€“ Zoom Out</button>
  </div>
  <div id="mapWrapper">
    <div id="mapContainer">
      <img id="adminMapImage" src="" />
    </div>
  </div>
</div>

<div id="locationSection">
  <h3>Location Manager</h3>
  <form id="locationForm">
    <input type="hidden" id="locationId" />
    <input type="text" id="locName" placeholder="Location Name" required />
    <input type="text" id="locFloor" placeholder="Floor" />
    <input type="text" id="locZone" placeholder="Zone (optional)" />
    <input type="text" id="locQR" placeholder="QR alias" />
    <button type="submit">Save Location</button>
  </form>
  <table id="locationsTable">
    <thead><tr><th>Name</th><th>Floor</th><th>Zone</th><th>QR Alias</th><th>Actions</th></tr></thead>
    <tbody id="locationsBody"></tbody>
  </table>
</div>

<script>
let selectedFloor = '';
let markers = [];
let locations = [];
let currentZoom = 1;
let isDragging = false;
let dragStart = {x: 0, y: 0};
let panOffset = {x: 0, y: 0};

function setZoom(scale) {
  currentZoom = Math.max(0.5, Math.min(3, scale));
  document.getElementById('mapContainer').style.transform = `translate(${panOffset.x}px, ${panOffset.y}px) scale(${currentZoom})`;
}

document.getElementById('mapWrapper').addEventListener('mousedown', e => {
  isDragging = true;
  dragStart = { x: e.clientX - panOffset.x, y: e.clientY - panOffset.y };
});
document.addEventListener('mouseup', () => isDragging = false);
document.addEventListener('mousemove', e => {
  if (!isDragging) return;
  panOffset = { x: e.clientX - dragStart.x, y: e.clientY - dragStart.y };
  document.getElementById('mapContainer').style.transform = `translate(${panOffset.x}px, ${panOffset.y}px) scale(${currentZoom})`;
});

function fetchMarkers() {
  fetch('/api/markers')
    .then(res => res.json())
    .then(data => {
      markers = data;
      document.querySelectorAll('.marker').forEach(el => el.remove());
      markers.filter(m => m.floor === selectedFloor).forEach(addMarkerToMap);
    });
}

function fetchLocations() {
  fetch('/api/locations')
    .then(res => res.json())
    .then(data => {
      locations = data;
      const tbody = document.getElementById('locationsBody');
      tbody.innerHTML = '';
      data.forEach(loc => {
        const row = tbody.insertRow();
        row.insertCell().innerText = loc.name;
        row.insertCell().innerText = loc.floor;
        row.insertCell().innerText = loc.zone;
        row.insertCell().innerText = loc.qr_alias;
        const actions = row.insertCell();
        const editBtn = document.createElement('button');
        editBtn.textContent = 'Edit';
        editBtn.onclick = () => {
          document.getElementById('locationId').value = loc.id;
          document.getElementById('locName').value = loc.name;
          document.getElementById('locFloor').value = loc.floor;
          document.getElementById('locZone').value = loc.zone;
          document.getElementById('locQR').value = loc.qr_alias;
        };
        const dragPin = document.createElement('div');
        dragPin.className = 'draggable-marker';
        dragPin.setAttribute('draggable', true);
        dragPin.addEventListener('dragstart', e => {
          e.dataTransfer.setData('text/plain', JSON.stringify(loc));
        });
        actions.appendChild(editBtn);
        actions.appendChild(dragPin);
      });
    });
}

document.getElementById('locationForm').addEventListener('submit', function (e) {
  e.preventDefault();
  const id = document.getElementById('locationId').value;
  const payload = {
    name: document.getElementById('locName').value,
    floor: document.getElementById('locFloor').value,
    zone: document.getElementById('locZone').value,
    qr_alias: document.getElementById('locQR').value
  };
  const method = id ? 'PUT' : 'POST';
  const url = id ? '/api/locations/' + id : '/api/locations';
  fetch(url, {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  }).then(() => {
    this.reset();
    fetchLocations();
  });
});

document.getElementById('uploadBtn').onclick = () => {
  const file = document.getElementById('mapFile').files[0];
  const floor = document.getElementById('floorInput').value.trim();
  if (!file || !floor) return alert('Select a file and enter floor name');
  const formData = new FormData();
  formData.append('map', file);
  formData.append('floor', floor);
  fetch('/api/upload', { method: 'POST', body: formData })
    .then(res => res.json())
    .then(result => {
      document.getElementById('uploadStatus').innerText = 'Uploaded: ' + result.file;
      loadMap();
    });
};

document.getElementById('loadMapBtn').onclick = () => {
  selectedFloor = document.getElementById('floorInput').value.trim();
  loadMap();
};

function loadMap() {
  const img = document.getElementById('adminMapImage');
  img.src = '/maps/' + selectedFloor + '.png';
  img.onload = () => fetchMarkers();
}

document.getElementById('mapContainer').addEventListener('dragover', e => e.preventDefault());
document.getElementById('mapContainer').addEventListener('drop', e => {
  e.preventDefault();
  const loc = JSON.parse(e.dataTransfer.getData('text/plain'));
  const rect = e.currentTarget.getBoundingClientRect();
  const x = (e.clientX - rect.left - panOffset.x) / currentZoom;
  const y = (e.clientY - rect.top - panOffset.y) / currentZoom;
  fetch('/api/markers', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      location_id: loc.id,
      x: Math.round(x),
      y: Math.round(y),
      floor: selectedFloor
    })
  }).then(() => fetchMarkers());
});

function addMarkerToMap(m) {
  const container = document.getElementById('mapContainer');
  const marker = document.createElement('div');
  marker.className = 'marker';
  marker.style.left = m.x + 'px';
  marker.style.top = m.y + 'px';
  marker.setAttribute('title', m.name || 'Unknown');
  marker.onclick = () => alert('Marker linked to: ' + (m.name || 'Unknown'));
  container.appendChild(marker);
}

fetchLocations();
</script>
</body>
</html>
